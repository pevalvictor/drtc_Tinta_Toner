{% extends 'layout.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">SALIDA DE PRODUCTOS</h2>

    <div class="text-end mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalSalida">Registrar Salida</button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-hover text-center" id="tablaSalidas">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Fecha de Salida</th>
                    <th>Destino</th>
                    <th>Responsable</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                {% for salida in salidas %}
                <tr>
                    <td>{{ salida.id_salida }}</td>
                    <td>{{ salida.producto.nombre }}</td>
                    <td>{{ salida.cantidad }}</td>
                    <td>{{ salida.fecha_salida.strftime('%Y-%m-%d') }}</td>
                    <td>{{ salida.destino }}</td>
                    <td>{{ salida.responsable }}</td>
                    <td>{{ salida.observaciones }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de registro de salida -->
<div class="modal fade" id="modalSalida" tabindex="-1">
  <div class="modal-dialog">
    <form id="formSalida" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Registrar Salida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-2">
        <div class="col-md-12">
          <label>Producto</label>
          <select name="id_producto" id="selectProducto" class="form-select form-select-sm" required>
            <option value="">Seleccionar...</option>
            {% for producto in productos %}
              <option value="{{ producto.id_producto }}">{{ producto.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6"><label>Tipo</label><input type="text" id="tipo" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Marca</label><input type="text" id="marca" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Color</label><input type="text" id="color" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Unidad</label><input type="text" id="unidad" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Cantidad</label><input type="number" name="cantidad" class="form-control form-control-sm" required></div>
        <div class="col-md-6"><label>Fecha</label><input type="date" name="fecha_salida" class="form-control form-control-sm" value="{{ current_date }}" required></div>
        <div class="col-md-12"><label>Destino</label><input name="destino" class="form-control form-control-sm" required></div>
        <div class="col-md-12"><label>Responsable</label><input name="responsable" class="form-control form-control-sm" required></div>
        <div class="col-md-12"><label>Observaciones</label><textarea name="observaciones" class="form-control form-control-sm" rows="2"></textarea></div>
      </div>
      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary btn-sm">Registrar</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="toastSalida" class="position-fixed top-0 end-0 p-3" style="z-index: 1055; display: none;">
  <div class="toast align-items-center text-white bg-success border-0 show" role="alert">
    <div class="d-flex">
      <div class="toast-body">Salida registrada</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="ocultarToast()"></button>
    </div>
  </div>
</div>

<script>
function mostrarToast() {
  const toast = document.getElementById("toastSalida");
  toast.style.display = "block";
  setTimeout(() => { toast.style.display = "none"; }, 3000);
}
function ocultarToast() {
  document.getElementById("toastSalida").style.display = "none";
}

document.getElementById("formSalida").addEventListener("submit", function (e) {
  e.preventDefault();
  const form = e.target;
  const datos = new FormData(form);

  fetch("/salidas/registrar_ajax", {
    method: "POST",
    body: datos
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      form.reset();
      document.querySelector("#modalSalida .btn-close").click();
      mostrarToast();
      setTimeout(() => location.reload(), 800);
    } else {
      alert(data.message);
    }
  });
});

document.getElementById("selectProducto").addEventListener("change", function () {
  const id = this.value;
  if (!id) return;

  fetch(`/productos/info/${id}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("tipo").value = data.tipo;
      document.getElementById("marca").value = data.marca;
      document.getElementById("color").value = data.color;
      document.getElementById("unidad").value = data.unidad;
    });
});
</script>
{% endblock %}
