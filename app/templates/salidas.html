<!-- Modal de registro de salida -->
<div class="modal fade" id="modalSalida" tabindex="-1" aria-labelledby="modalSalidaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="formSalida" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalSalidaLabel">Registrar Salida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body row g-2">
        <div class="col-md-12">
          <label>Producto</label>
          <select name="id_producto" id="selectProducto" class="form-select form-select-sm" required>
            <option value="">Seleccionar...</option>
            {% for producto in productos %}
              <option value="{{ producto.id_producto }}">{{ producto.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6"><label>Tipo</label><input type="text" id="tipo" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Marca</label><input type="text" id="marca" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Color</label><input type="text" id="color" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Unidad</label><input type="text" id="unidad" class="form-control form-control-sm" readonly></div>
        <div class="col-md-6"><label>Cantidad</label><input type="number" name="cantidad" class="form-control form-control-sm" required></div>
        <div class="col-md-6"><label>Fecha</label><input type="date" name="fecha_salida" class="form-control form-control-sm" value="{{ current_date }}" required></div>
        <div class="col-md-12"><label>Destino</label><input name="destino" class="form-control form-control-sm" required></div>
        <div class="col-md-12"><label>Responsable</label><input name="responsable" class="form-control form-control-sm" required></div>
        <div class="col-md-12"><label>Observaciones</label><textarea name="observaciones" class="form-control form-control-sm" rows="2"></textarea></div>
      </div>
      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary btn-sm">Registrar</button>
      </div>
    </form>
  </div>
</div>

<!-- Custom alert -->
<div class="modal fade" id="confirmEliminarModal" tabindex="-1" aria-labelledby="confirmEliminarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmEliminarLabel">Por favor confirme</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Está seguro de eliminar esta salida?
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="btnConfirmEliminar" class="btn btn-danger btn-sm">Eliminar</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal de Editart  Salidas -->
<div class="modal fade" id="modalEditarSalida" tabindex="-1" aria-labelledby="modalEditarSalidaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarSalida">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalEditarSalidaLabel">Editar Salida</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body row g-2">
          <input type="hidden" name="id_salida" id="edit_id_salida">
          <div class="col-md-12">
            <label>Producto</label>
            <select name="id_producto" id="edit_id_producto" class="form-select form-select-sm" required>
              {% for producto in productos %}
              <option value="{{ producto.id_producto }}">{{ producto.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label>Cantidad</label>
            <input type="number" name="cantidad" id="edit_cantidad" class="form-control form-control-sm" required>
          </div>
          <div class="col-md-6">
            <label>Fecha</label>
            <input type="date" name="fecha_salida" id="edit_fecha" class="form-control form-control-sm" required>
          </div>
          <div class="col-md-12">
            <label>Destino</label>
            <input name="destino" id="edit_destino" class="form-control form-control-sm">
          </div>
          <div class="col-md-12">
            <label>Responsable</label>
            <input name="responsable" id="edit_responsable" class="form-control form-control-sm">
          </div>
          <div class="col-md-12">
            <label>Observaciones</label>
            <textarea name="observaciones" id="edit_observaciones" class="form-control form-control-sm" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success btn-sm">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function mostrarToast(mensaje) {
  const toast = document.getElementById("toastMensaje");
  toast.querySelector(".toast-body").textContent = mensaje;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 2000);
}

// Registrar salida
document.getElementById("formSalida").addEventListener("submit", function (e) {
  e.preventDefault();
  const datos = new FormData(this);
  fetch("/salidas/registrar_ajax", {
    method: "POST",
    body: datos
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById("modalSalida")).hide();
      mostrarToast("Salida registrada");
      setTimeout(() => location.reload(), 500);
    } else {
      
    }
  });
});

// Cargar detalles al seleccionar producto
document.getElementById("selectProducto").addEventListener("change", function () {
  const id = this.value;
  if (!id) return;
  fetch(`/productos/info/${id}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("tipo").value = data.tipo;
      document.getElementById("marca").value = data.marca;
      document.getElementById("color").value = data.color;
      document.getElementById("unidad").value = data.unidad;
    });
});

// Para abir el modal  de edición con valores precargados
function editarSalida(id) {
  fetch(`/salidas/${id}/json`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("edit_id_salida").value = data.id_salida;
      document.getElementById("edit_id_producto").value = data.id_producto;
      document.getElementById("edit_cantidad").value = data.cantidad;
      document.getElementById("edit_fecha").value = data.fecha_salida;
      document.getElementById("edit_destino").value = data.destino;
      document.getElementById("edit_responsable").value = data.responsable;
      document.getElementById("edit_observaciones").value = data.observaciones;
      new bootstrap.Modal(document.getElementById("modalEditarSalida")).show();
    });
}

// Guardar edición y actualizar fila
document.getElementById("formEditarSalida").addEventListener("submit", function (e) {
  e.preventDefault();
  const id = document.getElementById("edit_id_salida").value;
  const datos = new FormData(this);
  fetch(`/salidas/${id}/editar`, {
    method: "POST",
    body: datos
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById("modalEditarSalida")).hide();
      mostrarToast("Salida actualizada");
      setTimeout(() => location.reload(), 500);
    } else {
      alert("Error al actualizar: " + data.message);
    }
  });
});


function eliminarSalida(id) {
  if (!confirm("¿Está seguro de eliminar esta salida?")) return;
  fetch(`/salidas/eliminar/${id}`, {
    method: "POST"
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      mostrarToast("Salida eliminada");
      setTimeout(() => location.reload(), 500);
    } else {
      alert("Error al eliminar: " + data.message);
    }
  });
}
</script>

<script>
let salidaAEliminar = null;
function eliminarSalida(id) {
  salidaAEliminar = id;
  new bootstrap.Modal(document.getElementById('confirmEliminarModal')).show();
}

document.getElementById('btnConfirmEliminar').addEventListener('click', function () {
  if (!salidaAEliminar) return;
  fetch(`/salidas/eliminar/${salidaAEliminar}`, {
    method: 'POST'
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        mostrarToast("Salida eliminada");
        setTimeout(() => location.reload(), 500);
      } else {
        alert("Error: " + data.message);
      }
    });
});

new bootstrap.Modal(document.getElementById('modalStockInsuficiente')).show();

</script>

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    $('#formSalida').on('submit', function (e) {
      e.preventDefault();

      const form = $(this);
      const formData = form.serialize();

      fetch('/salidas/registrar_ajax', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          location.reload(); 
        } else {
          if (data.message.includes("Stock insuficiente")) {
            new bootstrap.Modal(document.getElementById('modalStockInsuficiente')).show();
          } else {
       
            document.getElementById('mensajeAlerta').innerText = data.message;
            new bootstrap.Modal(document.getElementById('modalAlerta')).show();
          }
        }
      })
      .catch(err => {
        console.error('Error al registrar salida:', err);
        document.getElementById('mensajeAlerta').innerText = "Error de conexión con el servidor.";
        new bootstrap.Modal(document.getElementById('modalAlerta')).show();
      });
    });
  });
</script>
{% endblock %}

