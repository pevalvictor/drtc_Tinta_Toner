{% extends 'layout.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Reporte Consolidado de Productos</h2>

    <div class="table-responsive">
        <table id="tablaConsolidado" class="table table-bordered table-hover table-sm">
            <thead class="table-dark text-center">
                <tr>
                    <th class="no-export">ID</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Color</th>
                    <th>Unidad</th>
                    <th>Stock Inicial</th>
                    <th>Total Ingresos</th>
                    <th>Total Salidas</th>
                    <th>Stock Actual</th>
                </tr>
            </thead>
            <tbody>
                {% for item in consolidado %}
                <tr>
                    <td>{{ item.id_producto }}</td>
                    <td>{{ item.nombre }}</td>
                    <td>{{ item.tipo or '-' }}</td>
                    <td>{{ item.marca or '-' }}</td>
                    <td>{{ item.modelo_impresora or '-' }}</td>
                    <td>{{ item.color or '-' }}</td>
                    <td>{{ item.unidad or '-' }}</td>
                    <td>{{ item.stock_inicial }}</td>
                    <td>{{ item.total_ingresos }}</td>
                    <td>{{ item.total_salidas }}</td>
                    <td>{{ item.stock_actual }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Estilos e íconos -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Scripts exportación -->
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
$(document).ready(function () {
    const fechaActual = new Date().toISOString().split('T')[0];

    $('#tablaConsolidado').DataTable({
        dom: '<"d-flex justify-content-end mb-2"B>frtip',
        pageLength: 10,
        lengthMenu: [10, 25, 50],
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="bi bi-file-earmark-excel text-success"></i>',
                className: 'btn btn-outline-success btn-sm me-2',
                title: 'CONSOLIDADO_INVENTARIO_DRTC_' + fechaActual,
                customize: function (xlsx) {
                    const sheet = xlsx.xl.worksheets['sheet1.xml'];
                    $('row c[r^="A"]', sheet).remove(); // Eliminar columna ID
                    $('row', sheet).each(function () {
                        $('c[r^="A"]', this).first().remove();
                    });
                }
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="bi bi-file-earmark-pdf text-danger"></i>',
                className: 'btn btn-outline-danger btn-sm me-2',
                orientation: 'landscape',
                pageSize: 'A4',
                title: '',
                customize: function (doc) {
                    doc.content.splice(0, 0, {
                        text: 'REPORTE CONSOLIDADO DE INVENTARIO - DRTC   Fecha: ' + fechaActual,
                        alignment: 'center',
                        margin: [0, 0, 0, 12],
                        fontSize: 12,
                        bold: true
                    });
                    doc.content[1].table.body.forEach(row => row.splice(0, 1));
                }
            },
            {
                extend: 'print',
                text: '<i class="bi bi-printer"></i>',
                className: 'btn btn-outline-dark btn-sm',
                title: '',
                customize: function (win) {
                    $(win.document.body).prepend(
                        '<h5 class="text-center">REPORTE CONSOLIDADO DE INVENTARIO - DRTC   Fecha: ' + fechaActual + '</h5>'
                    );
                    $(win.document.body).find('table thead th:first-child, table tbody td:first-child').hide(); // Ocultar ID
                }
            }
        ],
        language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" },
        columnDefs: [
            {
                targets: 0, 
                visible: true,
                className: 'no-export'
            }
        ]
    });
});
</script>
{% endblock %}
