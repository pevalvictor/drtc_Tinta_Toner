{% extends 'layout.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">INGRESO DE PRODUCTOS</h2>

  <div class="row justify-content-between align-items-center mb-3">
    <div class="col-md-5">
      <input type="text" id="busquedaGeneral" class="form-control form-control-sm" placeholder="Buscar por tipo, marca o modelo">
    </div>
    <div class="col-md-2">
      <input type="date" id="fechaInicio" class="form-control form-control-sm">
    </div>
    <div class="col-md-2">
      <input type="date" id="fechaFin" class="form-control form-control-sm">
    </div>
    
    <div class="col-md-3 text-end">
        <a href="/ingresos/reporte/pdf" class="btn btn-sm btn-outline-danger" title="Exportar PDF">
          <i class="bi bi-file-earmark-pdf"></i>
        </a>
        <a href="/ingresos/reporte/excel" class="btn btn-sm btn-outline-success" title="Exportar Excel">
          <i class="bi bi-file-earmark-excel"></i>
        </a>
    </div>
  
  </div>


    <div class="text-end mb-3">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalIngreso">Registrar Ingreso</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle" id="tablaIngresosDT">
        <thead class="table-dark text-center">
          <tr>
              <th>ID</th>
              <th>Tipo</th>
              <th>Marca</th>
              <th>Modelo</th>
              <th>Cantidad</th>
              <th>Unidad</th>
              <th>Precio</th>
              <th>Total</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="tbodyIngreso">
                {% for ingreso in ingresos %}
               <tr data-bs-toggle="collapse" data-bs-target="#detalle{{ ingreso.id_ingreso }}" class="accordion-toggle">
                  <td>{{ ingreso.id_ingreso }}</td>
                  <td>{{ ingreso.tipo_producto }}</td>
                  <td>{{ ingreso.marca }}</td>
                  <td>{{ ingreso.modelo }}</td>
                  <td class="text-center">{{ ingreso.cantidad }}</td>
                  <td>{{ ingreso.unidad }}</td>
                  <td>S/. {{ ingreso.precio }}</td>
                  <td>S/. {{ ingreso.total }}</td>
                  <td>{{ ingreso.fecha_ingreso.strftime('%Y-%m-%d') }}</td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary me-1" title="Editar"
                      onclick="cargarDatosEditar({{ ingreso.id_ingreso }})">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" title="Eliminar"
                            onclick="eliminarIngreso({{ ingreso.id_ingreso }}, this)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>


                <tr>
                    <td colspan="10">
                        <div id="detalle{{ ingreso.id_ingreso }}" class="collapse bg-light p-3">
                            <strong>Color:</strong> {{ ingreso.color }} |
                            <strong>Stock:</strong> {{ ingreso.stock }} |
                            <strong>Stock Mínimo:</strong> {{ ingreso.stock_minimo }} |
                            <strong>Responsable:</strong> {{ ingreso.responsable }} <br>
                            <strong>Observaciones:</strong> {{ ingreso.observaciones }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- MODAL DE REGISTRO + CÁLCULO AUTOMÁTICO DE TOTAL -->
<div class="modal fade" id="modalIngreso" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="formNuevoIngreso" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Registrar Ingreso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <input type="hidden" name="id_producto" id="id_producto">

          <div class="col-md-6">
            <label>Tipo de Producto</label>
            <select name="tipo_producto" id="tipo_producto" class="form-select form-select-sm" required>
              <option value="Toner">Toner</option>
              <option value="Tinta">Tinta</option>
            </select>
          </div>

          <div class="col-md-5">
            <label>Marca</label>
            <input name="marca" id="marca" class="form-control form-control-sm" required>
          </div>

          <div class="col-md-1 d-flex align-items-end">
            <button type="button" class="btn btn-outline-primary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalBuscarProducto">
              <i class="bi bi-search"></i>
            </button>
          </div>

          <div class="col-md-6"><label>Modelo</label><input name="modelo" id="modelo" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Color</label><input name="color" id="color" class="form-control form-control-sm"></div>
          <div class="col-md-6"><label>Cantidad</label><input name="cantidad" id="cantidad" type="number" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Unidad</label><input name="unidad" id="unidad" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Precio</label><input name="precio" id="precio" type="number" step="0.01" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Total (S/)</label><input name="total" id="total" type="text" class="form-control form-control-sm" readonly></div>
          <div class="col-md-6"><label>Fecha de Ingreso</label><input name="fecha_ingreso" id="fecha_ingreso" type="date" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Stock</label><input name="stock" id="stock" type="number" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Stock Mínimo</label><input name="stock_minimo" id="stock_minimo" type="number" class="form-control form-control-sm" required></div>
          <div class="col-md-12"><label>Responsable</label><input name="responsable" id="responsable" class="form-control form-control-sm" required></div>
          <div class="col-md-12"><label>Observaciones</label><textarea name="observaciones" id="observaciones" class="form-control form-control-sm" rows="2"></textarea></div>
        </div>
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success btn-sm ms-2">Registrar</button>
        </div>
      </form>
    </div>
  </div>
</div>




<!-- Modal único de Edición -->
<div class="modal fade" id="modalEditarIngreso" tabindex="-1">
  <div class="modal-dialog modal-lg" style="max-width: 720px;">
    <div class="modal-content">
      <form id="formEditarIngreso" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Editar Ingreso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-2">
          <div class="col-md-6"><label>Tipo de Producto</label><select name="tipo_producto" class="form-select form-select-sm" required><option value="Toner">Toner</option><option value="Tinta">Tinta</option></select></div>
          <div class="col-md-6"><label>Marca</label><input name="marca" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Modelo</label><input name="modelo" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Color</label><input name="color" class="form-control form-control-sm"></div>
          <div class="col-md-6"><label>Cantidad</label><input name="cantidad" type="number" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Unidad</label><input name="unidad" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Precio</label><input name="precio" type="number" step="0.01" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Total (S/)</label><input name="total" type="text" class="form-control form-control-sm" readonly></div>
          <div class="col-md-6"><label>Fecha</label><input name="fecha_ingreso" type="date" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Stock</label><input name="stock" type="number" class="form-control form-control-sm" required></div>
          <div class="col-md-6"><label>Stock Mínimo</label><input name="stock_minimo" type="number" class="form-control form-control-sm" required></div>
          <div class="col-md-12"><label>Responsable</label><input name="responsable" class="form-control form-control-sm" required></div>
          <div class="col-md-12"><label>Observaciones</label><textarea name="observaciones" class="form-control form-control-sm" rows="2"></textarea></div>
        </div>
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary btn-sm ms-2">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>




<!-- MODAL DE BÚSQUEDA DE PRODUCTO -->
<div class="modal fade" id="modalBuscarProducto" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Buscar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="buscarInput" class="form-control mb-3" placeholder="Buscar por marca, modelo o color">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Marca</th>
              <th>Modelo</th>
              <th>Color</th>
              <th>Tipo</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="tablaProductos"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>




<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-trash me-2"></i> Confirmar eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        ¿Estás seguro que deseas eliminar este ingreso?
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnEliminarConfirmado">
          <i class="bi bi-check-circle"></i> Sí, eliminar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- DataTables core -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>



<script>

let productosCargados = [];

function cargarProductosExistentes() {
  fetch('/productos/lista')
    .then(res => res.json())
    .then(data => {
      productosCargados = data;
      const tbody = document.getElementById('tablaProductos');
      tbody.innerHTML = '';

      data.forEach((p, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${p.marca}</td>
          <td>${p.modelo}</td>
          <td>${p.color}</td>
          <td>${p.tipo}</td>
          <td><button class="btn btn-sm btn-success" onclick="seleccionarProducto(${index})">Seleccionar</button></td>
        `;
        tbody.appendChild(row);
      });
    })
    .catch(err => {
      console.error("Error al cargar productos:", err);
      mostrarToast("❌ Error al cargar productos", "danger");
    });
}

function seleccionarProducto(index) {
  const p = productosCargados[index];

  // Llenar los campos
  document.getElementById('id_producto').value = p.id;
  document.getElementById('marca').value = p.marca;
  document.getElementById('modelo').value = p.modelo;
  document.getElementById('color').value = p.color;
  document.getElementById('unidad').value = p.unidad;
  document.getElementById('tipo_producto').value = p.tipo;

  // Cerrar modal de búsqueda
  const modalBuscar = bootstrap.Modal.getInstance(document.getElementById('modalBuscarProducto'));
  if (modalBuscar) modalBuscar.hide();

  // Mostrar nuevamente el modal principal
  const modalIngreso = new bootstrap.Modal(document.getElementById('modalIngreso'));
  modalIngreso.show();

  // Enfocar en el siguiente campo (cantidad)
  document.getElementById('cantidad').focus();

  // Mostrar mensaje
  mostrarToast("✅ Producto cargado correctamente");
}

// Evento para que cargue los productos al abrir el modal
document.getElementById('modalBuscarProducto').addEventListener('show.bs.modal', cargarProductosExistentes);
</script>




<script>
document.getElementById('formNuevoIngreso').addEventListener('submit', function (e) {
  e.preventDefault(); 
  const form = e.target;
  const formData = new FormData(form);

  fetch('/ingresos/registrar_ajax', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      mostrarToast("✅ " + data.message);
      form.reset();
      document.getElementById('modalIngreso').querySelector('.btn-close').click();
      setTimeout(() => window.location.reload(), 100); 
    } else {
      mostrarToast("❌ Error: " + data.message);
    }
  })
  .catch(error => {
    mostrarToast("❌ Error inesperado");
    console.error(error);
  });
});

function mostrarToast(mensaje) {
  const container = document.createElement('div');
  container.className = 'toast align-items-center text-white bg-success border-0 show position-fixed top-0 end-0 m-3';
  container.setAttribute('role', 'alert');
  container.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${mensaje}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  document.body.appendChild(container);
  setTimeout(() => container.remove(), 4000);
}
</script>

<script>
function actualizarTotal() {
  const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
  const precio = parseFloat(document.getElementById('precio').value) || 0;
  document.getElementById('total').value = (cantidad * precio).toFixed(2);
}

document.getElementById('cantidad').addEventListener('input', actualizarTotal);
document.getElementById('precio').addEventListener('input', actualizarTotal);
</script>

<script>
function cargarDatosEditar(id) {
  fetch(`/ingresos/obtener/${id}`)
    .then(response => {
      if (!response.ok) throw new Error('No se pudo obtener el ingreso');
      return response.json();
    })
    .then(data => {
      const form = document.getElementById('formEditarIngreso');
      form.action = `/ingresos/editar/${id}`;
      form.tipo_producto.value = data.tipo_producto;
      form.marca.value = data.marca;
      form.modelo.value = data.modelo;
      form.color.value = data.color;
      form.cantidad.value = data.cantidad;
      form.unidad.value = data.unidad;
      form.precio.value = data.precio;
      form.total.value = (parseFloat(data.precio) * parseFloat(data.cantidad)).toFixed(2);
      form.fecha_ingreso.value = data.fecha_ingreso;
      form.stock.value = data.stock;
      form.stock_minimo.value = data.stock_minimo;
      form.responsable.value = data.responsable;
      form.observaciones.value = data.observaciones;

      const modal = new bootstrap.Modal(document.getElementById('modalEditarIngreso'));
      modal.show();
    })
    .catch(error => {
      console.error('Error al cargar datos del ingreso:', error);
      alert('Error al cargar los datos para edición.');
    });
}

// Activar cálculo total en modal de edición
document.getElementById('modalEditarIngreso').addEventListener('shown.bs.modal', () => {
  const form = document.getElementById('formEditarIngreso');
  const cantidad = form.querySelector('input[name="cantidad"]');
  const precio = form.querySelector('input[name="precio"]');
  const total = form.querySelector('input[name="total"]');

  function actualizarTotal() {
    const cant = parseFloat(cantidad.value) || 0;
    const pre = parseFloat(precio.value) || 0;
    total.value = (cant * pre).toFixed(2);
  }

  cantidad.addEventListener('input', actualizarTotal);
  precio.addEventListener('input', actualizarTotal);
});
</script>

<script>
document.getElementById('formEditarIngreso').addEventListener('submit', function (e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);

  fetch(form.action, {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarIngreso'));
      modal.hide();
      mostrarToast(' ' + data.message);
      setTimeout(() => location.reload(), 500);  
    } else {
      mostrarToast('❌ ' + data.message);
    }
  })
  .catch(err => {
    console.error(err);
    mostrarToast('❌ Error inesperado al guardar');
  });
});
</script>


<script>
document.getElementById("busquedaGeneral").addEventListener("keyup", function () {
  const valor = this.value.toLowerCase();
  document.querySelectorAll("tbody tr").forEach(function (fila) {
    const texto = fila.textContent.toLowerCase();
    fila.style.display = texto.includes(valor) ? "" : "none";
  });
});
</script>

<script>
  const modalElement = document.getElementById('modalEditarIngreso');
  modalElement.addEventListener('hidden.bs.modal', () => {
  document.body.classList.remove('modal-open');
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
});

</script>




<script>
function filtrarIngresosPorFecha() {
  const inicio = document.getElementById('fechaInicio').value;
  const fin = document.getElementById('fechaFin').value;

  fetch(`/ingresos/filtrar?inicio=${inicio}&fin=${fin}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('tbodyIngresos');
      tbody.innerHTML = '';
      data.forEach(ingreso => {
        const fila = `
          <tr>
            <td>${ingreso.id_ingreso}</td>
            <td>${ingreso.tipo_producto}</td>
            <td>${ingreso.marca}</td>
            <td>${ingreso.modelo}</td>
            <td>${ingreso.cantidad}</td>
            <td>${ingreso.unidad}</td>
            <td>S/. ${ingreso.precio}</td>
            <td>S/. ${ingreso.total}</td>
            <td>${ingreso.fecha_ingreso}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary" title="Editar" onclick="cargarDatosEditar(${ingreso.id_ingreso})"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-outline-danger ms-1" title="Eliminar" onclick="eliminarIngreso(${ingreso.id_ingreso})"><i class="bi bi-trash"></i></button>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', fila);
      });
    });
}

document.getElementById('fechaInicio').addEventListener('change', filtrarIngresosPorFecha);
document.getElementById('fechaFin').addEventListener('change', filtrarIngresosPorFecha);
</script>




<script>
function eliminarIngreso(id, icono) {
  if (!confirm("¿Eliminar este ingreso?")) return;

  fetch(`/ingresos/eliminar/${id}`, {
    method: 'POST'
  })
  .then(res => {
    if (!res.ok) throw new Error("Error al eliminar");
    mostrarToast(" Ingreso eliminado correctamente");

    const fila = icono.closest('tr');
    if (fila) fila.remove();
  })
  .catch(error => {
    console.error(error);
    mostrarToast("Error al eliminar ingreso");
  });
}
</script>




<script>
  let idIngresoAEliminar = null;
  let botonEliminarActual = null;

  function eliminarIngreso(id, boton) {
    idIngresoAEliminar = id;
    botonEliminarActual = boton;
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmarEliminar'));
    modal.show();
  }

  document.getElementById('btnEliminarConfirmado').addEventListener('click', function () {
    fetch(`/ingresos/eliminar/${idIngresoAEliminar}`, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
      const fila = botonEliminarActual.closest('tr');
      const filaDetalle = fila.nextElementSibling;  
      fila.remove();
      if (filaDetalle && filaDetalle.querySelector('.collapse')) {
        filaDetalle.remove();
      }

        mostrarToast(" Ingreso eliminado correctamente");
      } else {
        mostrarToast( data.message);
      }

      bootstrap.Modal.getInstance(document.getElementById('modalConfirmarEliminar')).hide();
    })
    .catch(err => {
      console.error(err);
      mostrarToast("Error al eliminar ingreso");
      bootstrap.Modal.getInstance(document.getElementById('modalConfirmarEliminar')).hide();
    });
  });
</script>



{% endblock %}

<script>
$(document).ready(function () {
  const tabla = $('#tablaIngresosDT').DataTable({
    language: {
      url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
    },
    pageLength: 10,
    lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
    ordering: true,
    autoWidth: false,
    responsive: true,
    rowCallback: function(row, data, index){
      if ($(row).find('td').length !== 10) {
        $(row).hide();
      }
    }
  });

  $('#busquedaGeneral').on('keyup', function () {
    tabla.search(this.value).draw();
  });
});
</script>
