{% extends 'layout.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Reportes - Ingresos de Productos</h2>

    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-md-3">
            <input type="date" id="filterFechaInicio" class="form-control" placeholder="Fecha Inicio">
        </div>
        <div class="col-md-3">
            <input type="date" id="filterFechaFin" class="form-control" placeholder="Fecha Fin">
        </div>
        <div class="col-md-6 d-flex">
            <button id="applyFilters" class="btn btn-primary w-100 me-2">Aplicar Filtros</button>
            <button id="resetFilters" class="btn btn-secondary w-100">Restablecer Filtros</button>
        </div>
    </div>
    <div class="text-end mb-3">
      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalNuevoIngreso">
        <i class="bi bi-plus-circle"></i> Nuevo Ingreso
      </button>
    </div>
    

    <div class="table-responsive">
        <table id="tablaIngresos" class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Fecha de Ingreso</th>
                    <th>Responsable</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
                {% for ingreso in ingresos %}
                <tr>
                    <td>{{ ingreso.id_ingreso }}</td>
                    <td>{{ ingreso.producto.nombre }}</td>
                    <td>{{ ingreso.cantidad }}</td>
                    <td>{{ ingreso.fecha_ingreso.strftime('%d/%m/%Y') }}</td>
                    <td>{{ ingreso.responsable or '-' }}</td>
                    <td>{{ ingreso.observaciones or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


  <!-- Modal: Nuevo Ingreso -->
<div class="modal fade" id="modalNuevoIngreso" tabindex="-1" aria-labelledby="modalNuevoIngresoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalNuevoIngresoLabel">Registrar Ingreso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formIngreso" method="POST" action="{{ url_for('ingresos.nuevo_ingreso_ajax') }}">


          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Tipo de Producto *</label>
              <select name="id_tipo" id="tipoSelect" class="form-select" required>
                <option value="">Seleccione tipo</option>
                {% for tipo in tipos_productos %}
                  <option value="{{ tipo.id_tipo }}">{{ tipo.nombre_tipo }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Producto *</label>
              <select name="id_producto" id="productoSelect" class="form-select" required disabled>
                <option value="">Seleccione producto</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Cantidad *</label>
              <input type="number" name="cantidad" class="form-control" min="1" required>
            </div>
            <div class="col-md-8 mb-3">
              <label class="form-label">Responsable</label>
              <input type="text" name="responsable" class="form-control" value="{{ current_user.nombre_completo }}" readonly>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Observaciones</label>
              <textarea name="observaciones" class="form-control" rows="2"></textarea>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Registrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>




  
</div>

<!-- DataTables Buttons -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
$(document).ready(function() {
    var table = $('#tablaIngresos').DataTable({
        dom: 'Bfrtip',
        buttons: [
            { extend: 'excelHtml5', text: 'Exportar a Excel', title: 'Ingresos_DRTC' },
            { extend: 'pdfHtml5', text: 'Exportar a PDF', title: 'Ingresos_DRTC', orientation: 'landscape', pageSize: 'A4' },
            { extend: 'print', text: 'Imprimir', title: 'Ingresos de Productos - DRTC' }
        ],
        language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json" }
    });

    function aplicarFiltros() {
        var fechaInicio = $('#filterFechaInicio').val();
        var fechaFin = $('#filterFechaFin').val();

        table.rows().every(function() {
            var fecha = this.data()[3]; // Fecha en formato 'dd/mm/yyyy'
            var partes = fecha.split('/');
            var fechaIngreso = new Date(partes[2], partes[1] - 1, partes[0]); // Año, mes, día

            var mostrar = true;
            if (fechaInicio) {
                var inicio = new Date(fechaInicio);
                if (fechaIngreso < inicio) mostrar = false;
            }
            if (fechaFin) {
                var fin = new Date(fechaFin);
                if (fechaIngreso > fin) mostrar = false;
            }

            if (mostrar) {
                $(this.node()).show();
            } else {
                $(this.node()).hide();
            }
        });
    }

    $('#applyFilters').click(function() {
        aplicarFiltros();
    });

    $('#resetFilters').click(function() {
        $('#filterFechaInicio').val('');
        $('#filterFechaFin').val('');
        table.search('').columns().search('').draw();
        table.rows().show();
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const tipoSelect = document.getElementById("tipoSelect");
    const productoSelect = document.getElementById("productoSelect");

    tipoSelect.addEventListener("change", function () {
      const tipoId = this.value;

      productoSelect.innerHTML = '<option value="">Cargando productos...</option>';
      productoSelect.disabled = true;

      fetch(`/api/productos_por_tipo/${tipoId}`)
        .then(response => response.json())
        .then(data => {
          productoSelect.innerHTML = '<option value="">Seleccione producto</option>';
          data.forEach(producto => {
            const option = document.createElement("option");
            option.value = producto.id_producto;
            option.textContent = producto.nombre;
            productoSelect.appendChild(option);
          });
          productoSelect.disabled = false;
        })
        .catch(error => {
          productoSelect.innerHTML = '<option value="">Error al cargar</option>';
          console.error('Error al cargar productos:', error);
        });
    });
  });
  
</script>

<script>
  document.getElementById("formIngreso").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
  
      fetch(form.action, {
          method: "POST",
          body: formData
      })
      .then(resp => resp.json())
      .then(data => {
          if (data.status === "success") {
              const nuevo = data.nuevo;
              const tabla = document.querySelector("#tablaIngresos tbody");
  
              const fila = tabla.insertRow(0); // insertamos al inicio
              fila.innerHTML = `
                  <td>${nuevo.id_ingreso}</td>
                  <td>${nuevo.producto}</td>
                  <td>${nuevo.cantidad}</td>
                  <td>${nuevo.fecha_ingreso}</td>
                  <td>${nuevo.responsable}</td>
                  <td>${nuevo.observaciones}</td>
              `;
  
              // resetear el formulario y cerrar el modal
              form.reset();
              document.getElementById("productoSelect").innerHTML = '<option value="">Seleccione producto</option>';
              document.getElementById("productoSelect").disabled = true;
              const modal = bootstrap.Modal.getInstance(document.getElementById("modalNuevoIngreso"));
              modal.hide();
  
              // opcional: alerta visual
              alert(data.mensaje);
          } else {
              alert(data.mensaje);
          }
      })
      .catch(err => {
          console.error("Error al enviar ingreso:", err);
          alert("Error inesperado al registrar ingreso.");
      });
  });
  </script>
  
{% endblock %}
